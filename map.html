<html>
	<head>
            <meta charset="UTF-8">
            <style>
            #map {
                width: 100%;
                height: 100%;
            }
            </style>
            <script src="./webrtcstreamer.json"></script>
            <script type="module" src="./webrtc-streamer-element.js"></script>
            <script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAij6NExe6cr7-eLCNaGPwI-YYkLkMgBq8"></script>
            <script src="./htmlmapmarker.js"></script>
    </head>
	<body>
       
       <div id="map"></div>

       <script>
         const width = 64;
         const height = 48;
         const mapOptions = {
           zoom: 2,
           center: new google.maps.LatLng(0,0)
         };
         const map = new google.maps.Map(document.getElementById("map"), mapOptions);

         let mediaList = {
           "Curacao" : new google.maps.LatLng(12.2376122,-69.1801954),
           "Scheveningen-1" : new google.maps.LatLng(52.1042263,4.2494571),
           "Vavrisovo": new google.maps.LatLng(49.0758931,19.7501234),
           "VirginiaTech": new google.maps.LatLng(37.223357,-80.417004),
           "Pa√ßoDeArcos": new google.maps.LatLng(38.701468,-9.3101928),
           "Arrifana": new google.maps.LatLng(37.2919477,-8.8700988),
           "HK": new google.maps.LatLng(22.352734,114.1277)
         }
         
         let markerList = {};
         for (let [key, latlng] of Object.entries(mediaList))  {
              let marker = new HTMLMapMarker({
                latlng,
                map,
                html: `<webrtc-streamer id="${key}" url='{"video":"${key}"}' options='width=64&height=48&rtptransport=tcp&timeout=60' notitle width='100%' height='100%'></webrtc-streamer>`,
                width,
                height
              });      
              google.maps.event.addListener(marker, 'click', function() {

                let focusMarker = new HTMLMapMarker({
                  latlng,
                  map,
                  html: `<webrtc-streamer id="${key}-focus" url='{"video":"${key}"}' options='width=640&height=480&rtptransport=tcp&timeout=60' width='100%' height='100%'></webrtc-streamer>`,
                  width: 640,
                  height: 480
                });      
                google.maps.event.addListener(focusMarker, 'click', function() {
                  focusMarker.detach();
                });

              });
              markerList[key] = marker;     
         }
         
        map.addListener('zoom_changed', function() {
          let zoom = map.getZoom();
          for (let [key, marker] of Object.entries(markerList))  {
              const webrtc = document.getElementById(key);
              marker.setSize(`${width*zoom/4}`, `${height*zoom/4}`);    
            }
        });

        map.addListener('idle', function() {
            var bounds = map.getBounds();
            let zoom = map.getZoom();

            for (let [key, marker] of Object.entries(markerList))  {
              if(bounds.contains(marker.getPosition())===true) {
                marker.attach();
                marker.setSize(`${width*zoom/4}`, `${height*zoom/4}`);              
              } else {
                marker.detach();
              }
            }
        });

         
       </script>       
	</body>
</html>