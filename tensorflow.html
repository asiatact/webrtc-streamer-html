<html>
<head>
<script src="libs/tfjs"> </script>
<script src="libs/coco-ssd"> </script>
<script src="libs/request.min.js" ></script>
<script src="libs/adapter.min.js" ></script>
<script src="webrtcstreamer.js" ></script>
    <style>
        video {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 0);
            z-index: -1;
        }
        canvas {
            position: absolute;
            left: 50%;
            transform: translate(-50%, 0);
            z-index:1;
        }
        div {
            position: relative;
        }
    </style>
</head>
<body> 
    <div>
        <video id="video" muted >
        </video>
        <canvas id="canvas" >
        </canvas>
    </div>
    <div id="detections">
    </div>
    <script>
    var url = { video:"Scheveningen-3" };  
    var options = "rtptransport=tcp&timeout=60";
    if (typeof URLSearchParams != 'undefined') {
        var params = new URLSearchParams(location.search);
        if (params.has("video") || params.has("audio")) {
            url = { video:params.get("video"), audio:params.get("audio") };
        }
        if (params.has("options")) {
            options = params.get("options");
        }
    } 	    
    var webRtcServer      = new WebRtcStreamer("video");
    webRtcServer.connect(url.video, url.audio, options);
    window.onbeforeunload = function() { webRtcServer.disconnect(); }

    function runDetect(model, video) {

        console.time('predict');
        // detect objects in the image.
        model.detect(video).then(predictions => {
            console.timeEnd('predict');
            console.log('Predictions: ', predictions);

            const c = document.getElementById('canvas');
            c.width = video.videoWidth;
            c.height = video.videoHeight;
            const context = c.getContext('2d');
            context.clearRect(0, 0, c.width, c.height);
            context.font = '10px Arial';

            console.log('number of detections: ', predictions.length);
            for (let i = 0; i < predictions.length; i++) {
                context.beginPath();
                context.rect(...predictions[i].bbox);
                context.lineWidth = 1;
                context.strokeStyle = 'green';
                context.fillStyle = 'green';
                context.stroke();
                context.fillText(
                predictions[i].score.toFixed(3) + ' ' + predictions[i].class, predictions[i].bbox[0],
                predictions[i].bbox[1] > 10 ? predictions[i].bbox[1] - 5 : 10);
            }

            const d = document.getElementById('detections');
            d.innerHTML = "";
            predictions.map( prediction => prediction.class ).forEach( (className) => {
                d.appendChild( document.createTextNode(className) )
                d.appendChild( document.createElement("br") )
            } )
 
            window.setTimeout( ()=>{ runDetect(model,video); } , 0 )
        });
    }

    // Load the model.
    console.time('model');
    cocoSsd.load().then(model => {
        console.log('model loaded');
        console.timeEnd('model');

        const video = document.getElementById('video');
        video.addEventListener('loadeddata', () => { runDetect(model, video)} );

    });

    </script>
</body>
</html>
